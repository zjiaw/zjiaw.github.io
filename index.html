<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026ä¹Ÿè¦åŠ æ²¹é¸­ï¼ï¼ï¼</title>
    <script src="https://lib.baomitu.com/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* ================= CSS æ ·å¼åŒºåŸŸ ================= */
        :root { --china-red: #d32f2f; --gold: #ffcf5e; --paper: #fff9c4; --grape-green: #9acd32; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: "Microsoft YaHei", sans-serif; background: #000; overflow-x: hidden; color: white; }
        .view-section { display: none; min-height: 100vh; width: 100%; flex-direction: column; align-items: center; justify-content: center; position: relative; padding-bottom: 50px; overflow: hidden; }
        .view-section.active { display: flex; }

        /* è§†é¢‘èƒŒæ™¯ */
        .video-bg { position: absolute; top: 50%; left: 50%; min-width: 100%; min-height: 100%; width: auto; height: auto; z-index: 0; transform: translateX(-50%) translateY(-50%); object-fit: cover; opacity: 0.8; }

        /* çƒŸèŠ±å±‚ */
        canvas#fireworks { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }

        /* å†…å®¹å±‚ */
        .lantern, .timer-container, .nav-btn, h1, #grape-layer, .controls, #music-controls { position: relative; z-index: 10; }

        .nav-btn { margin-top: 30px; padding: 10px 20px; border: 1px solid var(--gold); background: rgba(0,0,0,0.4); color: var(--gold); border-radius: 20px; cursor: pointer; font-size: 14px; transition: 0.3s; }
        .nav-btn:hover { background: var(--gold); color: #b71c1c; }
        .lantern { position: absolute; top: 20px; font-size: 60px; filter: drop-shadow(0 0 10px rgba(0,0,0,0.3)); }
        .lantern-l { left: 10%; } .lantern-r { right: 10%; }
        .timer-container { display: flex; gap: 20px; margin-top: 30px; padding: 20px; }
        .flip-card { background: linear-gradient(180deg, #b71c1c 0%, #d32f2f 100%); width: 90px; height: 120px; border-radius: 12px; font-size: 70px; font-weight: bold; color: var(--gold); display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 0px #8b1515, 0 15px 25px rgba(0,0,0,0.4); border: 2px solid var(--gold); }
        .flip-label { text-align: center; margin-top: 15px; font-size: 18px; color: var(--gold); font-weight: bold; }

        /* æ„¿æœ›æ¿ */
        #view-2 { background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png'); background-color: var(--china-red); }
        #capture-area { width: 90%; max-width: 900px; display: flex; flex-direction: column; align-items: center; padding: 20px; border-radius: 10px; background: #b71c1c; border: 8px double var(--gold); box-shadow: inset 0 0 20px rgba(0,0,0,0.5); transition: background 0.3s; position: relative; background-size: cover; background-position: center; }
        .board-content { width: 100%; min-height: 400px; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 20px; justify-content: center; }
        .note { width: 150px; height: 150px; background: var(--paper); padding: 15px; color: #333; box-shadow: 5px 5px 15px rgba(0,0,0,0.3); transform: rotate(-2deg); display: flex; flex-direction: column; justify-content: space-between; position: relative; border-bottom-right-radius: 30px 5px; }
        .note:nth-child(even) { transform: rotate(2deg); }
        .note.completed { background: #d1d1d1; text-decoration: line-through; opacity: 0.8; }
        .delete-btn { position: absolute; top: 5px; right: 5px; cursor: pointer; color: #999; font-weight: bold; }

        .diy-toolbar { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: center; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 30px; border: 1px solid var(--gold); }
        .diy-btn { background: var(--gold); border: none; padding: 5px 15px; border-radius: 20px; color: #b71c1c; font-weight: bold; cursor: pointer; font-size: 12px; }
        .bg-preset { width: 35px; height: 35px; border-radius: 8px; border: 2px solid rgba(255,255,255,0.7); cursor: pointer; background-size: cover; background-position: center; transition: transform 0.2s, border-color 0.2s; }
        .bg-preset:hover { transform: scale(1.1); border-color: var(--gold); }

        .controls { margin-top: 20px; text-align: center; width: 100%; display: flex; justify-content: center; }
        input#wishInput { padding: 12px; border: none; width: 200px; outline: none; border: 2px solid var(--gold); border-radius: 5px 0 0 5px; }
        button.add-btn { padding: 12px 20px; background: var(--gold); border: 2px solid var(--gold); cursor: pointer; font-weight: bold; color: #b71c1c; border-radius: 0 5px 5px 0; }
        button.share-btn { margin-top: 30px; padding: 15px 40px; border-radius: 40px; background: var(--gold); color: #b71c1c; border: none; font-weight: bold; font-size: 18px; cursor: pointer; box-shadow: 0 6px 15px rgba(0,0,0,0.3); }

        /* ğŸ”¥ éŸ³ä¹æ’­æ”¾å™¨æ‚¬åœäº¤äº’åŒº ğŸ”¥ */
        #music-controls { position: fixed; top: 20px; right: 20px; display: flex; flex-direction: column; align-items: flex-end; gap: 10px; z-index: 100; }

        #music-row {
            display: flex; align-items: center;
            padding: 5px; border-radius: 30px;
            transition: all 0.3s;
        }


        #music-player {
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(0,0,0,0.6); border: 2px solid var(--gold);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; user-select: none; font-size: 20px;
            z-index: 2; /* ä¿è¯å›¾æ ‡åœ¨æœ€ä¸Šå±‚ */
        }
        .rotating { animation: spin 4s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .volume-hidden-area {
            width: 0;           /* å¹³æ—¶å®½åº¦ä¸º0 */
            opacity: 0;         /* å¹³æ—¶é€æ˜ */
            overflow: hidden;   /* è¶…å‡ºéšè— */
            display: flex; align-items: center; gap: 5px;
            /* å…³é”®ç‚¹ï¼šç¦»å¼€æ—¶æ²¡æœ‰å»¶è¿Ÿï¼Œè¿…é€Ÿæ”¶å› */
            transition: width 0.4s ease, opacity 0.4s ease;
        }

        #volume-slider { width: 80px; height: 4px; accent-color: var(--gold); cursor: pointer; margin-right: 10px; }

        #music-row:hover {
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--gold);
        }

        /* å½“é¼ æ ‡æ‚¬åœåœ¨æ•´ä¸ªå®¹å™¨ä¸Šæ—¶ï¼Œæ§åˆ¶éŸ³é‡åŒºåŸŸçš„æ˜¾ç¤º */
        #music-row:hover .volume-hidden-area {
            width: 100px; /* å±•å¼€å®½åº¦ */
            opacity: 1;   /* æ˜¾ç¤º */
            transition-delay: 0.5s;
        }

        #playlist-panel { display: none; background: rgba(0,0,0,0.85); border: 1px solid var(--gold); border-radius: 10px; padding: 10px; min-width: 150px; margin-top: 5px; }
        #playlist-panel.show { display: block; }
        .song-item { padding: 8px 12px; color: #ddd; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 14px; }
        .song-item.active { color: var(--gold); font-weight: bold; }

        /* è‘¡è„ */
        #grape-layer { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 50; flex-direction: column; align-items: center; justify-content: center; animation: fadeIn 0.5s; }
        #grape-layer.active { display: flex; }
        .grape-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; max-width: 320px; }
        .grape { width: 60px; height: 60px; background: var(--grape-green); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #050a10; font-weight: bold; font-size: 24px; box-shadow: inset -5px -5px 10px rgba(0,0,0,0.2), 0 0 15px rgba(154, 205, 50, 0.6); transition: all 0.2s; }
        .grape.eaten { background: #444; color: #666; transform: scale(0.8); opacity: 0.3; box-shadow: none; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        @media (max-width: 600px) { h1 { font-size: 1.5rem !important; } .timer-container { gap: 10px; padding: 10px; } .flip-card { width: 60px; height: 80px; font-size: 36px; } .lantern { font-size: 40px; top: 10px; } #capture-area { width: 95%; padding: 10px; } input#wishInput { width: 140px; } .grape { width: 50px; height: 50px; font-size: 18px; } }
    </style>
</head>
<body>

<div id="music-controls">
    <div id="music-row">
        <div class="volume-hidden-area">
            <span style="font-size:12px; margin-left:10px;">ğŸ”ˆ</span>
            <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.3" oninput="changeVolume(this.value)">
        </div>

        <div id="music-player" onclick="toggleMusic()">ğŸµ</div>
    </div>
    <div style="font-size: 24px; cursor: pointer; text-align:right; margin-right:10px;" onclick="document.getElementById('playlist-panel').classList.toggle('show')">ğŸ“œ</div>

    <div id="playlist-panel"></div>
</div>
<audio id="bgm" loop></audio>

<div id="view-1" class="view-section">
    <video autoplay muted loop playsinline class="video-bg">
        <source src="bg1.mp4" type="video/mp4">
    </video>

    <h1 style="color: var(--gold); letter-spacing: 5px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); font-size: 2.5rem; text-align: center;">è·ç¦» 2026 è·¨å¹´è¿˜æœ‰</h1>

    <div class="timer-container">
        <div><div class="flip-card" id="d">00</div><div class="flip-label">å¤©</div></div>
        <div><div class="flip-card" id="h">00</div><div class="flip-label">æ—¶</div></div>
        <div><div class="flip-card" id="m">00</div><div class="flip-label">åˆ†</div></div>
        <div><div class="flip-card" id="s">00</div><div class="flip-label">ç§’</div></div>
    </div>
       
    
    <button class="nav-btn" onclick="switchView(2)">âœï¸ å»å†™æˆ‘çš„æ–°å¹´æ„¿æœ›</button>
    <canvas id="fireworks"></canvas>

    <div id="grape-layer">
        <h2 style="color: var(--gold); margin-bottom: 20px; font-size: 2rem;">ğŸ‡ å‡†å¤‡åƒè‘¡è„ï¼ ğŸ‡</h2>
        <div class="grape-container">
            <div class="grape" id="g12">12</div><div class="grape" id="g11">11</div>
            <div class="grape" id="g10">10</div><div class="grape" id="g9">9</div>
            <div class="grape" id="g8">8</div><div class="grape" id="g7">7</div>
            <div class="grape" id="g6">6</div><div class="grape" id="g5">5</div>
            <div class="grape" id="g4">4</div><div class="grape" id="g3">3</div>
            <div class="grape" id="g2">2</div><div class="grape" id="g1">1</div>
        </div>
        <p style="margin-top:20px; font-size: 1.2rem; color: #ccc;">è·Ÿç€å€’æ•°ï¼Œä¸€ç§’ä¸€é¢—ï¼</p>
    </div>
    <button onclick="startGrapeTest()" style="position:fixed; bottom:10px; left:10px; z-index:999; opacity:0.5; font-size:12px; padding:5px;">ğŸ‡ åƒè‘¡è„å€’æ•°æ¨¡å¼</button>
</div>

<div id="view-2" class="view-section">
    <div class="diy-toolbar">
        <span style="font-size:12px; color:var(--gold)">ğŸ¨ è£…ä¿®èƒŒæ™¯:</span>
        <button class="diy-btn" onclick="document.getElementById('bg-upload').click()">ğŸ“‚ ä¸Šä¼ </button>
        <input type="file" id="bg-upload" accept="image/*" style="display:none" onchange="uploadBg(this)">

        <div class="bg-preset" style="background-image: url('bj1.png')" onclick="setBgImage('bj1.png')"></div>
        <div class="bg-preset" style="background-image: url('/static/media/bj2.jpg')" onclick="setBgImage('/static/media/bj2.jpg')"></div>
        <div class="bg-preset" style="background-image: url('/static/media/bj3.jpg')" onclick="setBgImage('/static/media/bj3.jpg')"></div>
        <button class="diy-btn" style="padding: 5px 10px; font-size: 10px;" onclick="setBgColor('#b71c1c')">ğŸ”„ é»˜è®¤</button>
    </div>

    <div id="capture-area">
        <h1 style="color: var(--gold); text-shadow: 2px 2px 5px rgba(0,0,0,0.5); font-size: 2rem; margin-bottom: 20px; text-align: center;">ğŸ® 2026 æ„¿æœ›æ¸…å• ğŸ®</h1>
        <div class="board-content" id="wishBoard"></div>
    </div>

    <div class="controls">
        <input type="text" id="wishInput" placeholder="å†™ä¸‹æ˜å¹´çš„åŠ¨åŠ›å§...">
        <button class="add-btn" onclick="saveWish()">è´´è´´</button>
    </div>

    <button class="share-btn" onclick="share()">ğŸ“¸ ä¿å­˜æˆ‘çš„ DIY æ„¿æœ›å•</button>
    <button id="back-to-timer-btn" class="nav-btn" onclick="switchView(1)">â¬…ï¸ è¿”å›å€’è®¡æ—¶</button>
</div>

<script>
    const TARGET_DATE = new Date('2026-01-01 00:00:00').getTime();

    // éŸ³ä¹é€»è¾‘
    const songList = [
        { name: "ğŸµ æ­å–œä½ å‘è´¢", url: "bj1.mp3" },
        { name: "ğŸµ è¥¿æ¥¼åˆ«ç»ª", url: "bj2.mp3" },
        { name: "ğŸµ è´è¶", url: "bj3.mp3" }
    ];

    let currentSongIndex = 0;
    const bgm = document.getElementById('bgm');
    const musicPlayer = document.getElementById('music-player');

    // åˆå§‹åŒ–éŸ³é‡ï¼š30%
    bgm.volume = 0.28;

    function changeVolume(val) {
        bgm.volume = val;
    }

    function initMusic() {
        const panel = document.getElementById('playlist-panel'); panel.innerHTML = '';
        songList.forEach((song, index) => {
            const div = document.createElement('div'); div.className = `song-item ${index === currentSongIndex ? 'active' : ''}`;
            div.innerText = song.name; div.onclick = () => playSong(index); panel.appendChild(div);
        });
    }
    function playSong(index) {
        currentSongIndex = index; bgm.src = songList[index].url;
        bgm.play().then(() => { console.log("æ’­æ”¾æˆåŠŸ"); musicPlayer.classList.add('rotating'); })
            .catch(e => { console.error(e); musicPlayer.classList.remove('rotating'); alert("æ’­æ”¾å¤±è´¥ï¼šæ‰¾ä¸åˆ°æ–‡ä»¶ " + songList[index].url + "\nè¯·ç¡®è®¤mp3æ–‡ä»¶å’Œhtmlåœ¨åŒä¸€ä¸ªæ–‡ä»¶å¤¹é‡Œï¼"); });
        initMusic();
    }
    function toggleMusic() {
        if (bgm.paused) {
            if (!bgm.src) bgm.src = songList[currentSongIndex].url;
            bgm.play().then(() => musicPlayer.classList.add('rotating'))
                .catch(e => { alert("æ— æ³•æ’­æ”¾ï¼Œè¯·ç‚¹å‡»ä¸€ä¸‹é¡µé¢ä»»æ„ä½ç½®åå†è¯•ã€‚"); });
        } else { bgm.pause(); musicPlayer.classList.remove('rotating'); }
    }
    initMusic();

    // å€’è®¡æ—¶ & è‘¡è„
    function initApp() {
        const now = new Date().getTime();
        if (now >= TARGET_DATE) {
            document.getElementById('view-2').classList.add('active');
            const v1 = document.getElementById('view-1'); if(v1) v1.remove();
            const backBtn = document.getElementById('back-to-timer-btn'); if(backBtn) backBtn.style.display = 'none';
        } else { document.getElementById('view-1').classList.add('active'); startTimer(); startFireworks(); }
    }
    function switchView(n) { document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active')); document.getElementById(`view-${n}`).classList.add('active'); }
    function startTimer() {
        const timer = setInterval(() => {
            const now = new Date().getTime(); const diff = TARGET_DATE - now;
            if (diff <= 0) { clearInterval(timer); location.reload(); return; }
            document.getElementById('d').innerText = Math.floor(diff / (1000 * 60 * 60 * 24)).toString().padStart(2, '0');
            document.getElementById('h').innerText = Math.floor((diff / (1000 * 60 * 60)) % 24).toString().padStart(2, '0');
            document.getElementById('m').innerText = Math.floor((diff / 1000 / 60) % 60).toString().padStart(2, '0');
            document.getElementById('s').innerText = Math.floor((diff / 1000) % 60).toString().padStart(2, '0');
            const secondsLeft = diff / 1000; if (secondsLeft <= 12.5 && secondsLeft > 0) { showGrapes(Math.ceil(secondsLeft)); }
        }, 1000);
    }
    function showGrapes(seconds) {
        const layer = document.getElementById('grape-layer'); if (!layer.classList.contains('active')) layer.classList.add('active');
        for (let i = 12; i >= 1; i--) {
            const grape = document.getElementById(`g${i}`);
            if (i > seconds) { grape.classList.add('eaten'); } else { grape.classList.remove('eaten'); if(i === seconds) grape.style.transform = "scale(1.1)"; }
        }
    }
    function startGrapeTest() { let testSec = 13; alert("æ¨¡æ‹Ÿæœ€å12ç§’åƒè‘¡è„"); const testTimer = setInterval(() => { testSec--; if(testSec <= 0) { clearInterval(testTimer); alert("æ–°å¹´å¿«ä¹ï¼æµ‹è¯•ç»“æŸ"); location.reload(); } else { showGrapes(testSec); } }, 1000); }

    //æ„¿æœ›æ¿
    let db; const request = indexedDB.open("Year2026DB", 1);
    request.onupgradeneeded = e => { db = e.target.result; db.createObjectStore("wishes", { keyPath: "id", autoIncrement: true }); };
    request.onsuccess = e => { db = e.target.result; renderWishes(); };
    function saveWish() { const val = document.getElementById('wishInput').value; if (!val) return; const tx = db.transaction("wishes", "readwrite"); tx.objectStore("wishes").add({ text: val, done: false }); tx.oncomplete = () => { document.getElementById('wishInput').value = ''; renderWishes(); }; }
    function renderWishes() { const board = document.getElementById('wishBoard'); board.innerHTML = ''; if(!db) return; db.transaction("wishes").objectStore("wishes").openCursor().onsuccess = e => { const cursor = e.target.result; if (cursor) { const item = cursor.value; const div = document.createElement('div'); div.className = `note ${item.done ? 'completed' : ''}`; div.innerHTML = `<span class="delete-btn" onclick="deleteWish(${item.id})">Ã—</span><p style="word-break:break-all; margin-top:10px;">${item.text}</p><label style="font-size:12px;cursor:pointer"><input type="checkbox" ${item.done ? 'checked' : ''} onchange="toggle(${item.id})"> å·²å®ç°</label>`; board.appendChild(div); cursor.continue(); } }; }
    function deleteWish(id) { if(confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ')) { const tx = db.transaction("wishes", "readwrite"); tx.objectStore("wishes").delete(id); tx.oncomplete = renderWishes; } }
    function toggle(id) { const tx = db.transaction("wishes", "readwrite"); const store = tx.objectStore("wishes"); store.get(id).onsuccess = e => { const d = e.target.result; d.done = !d.done; store.put(d); }; tx.oncomplete = renderWishes; }
    function share() { html2canvas(document.querySelector("#capture-area"), { useCORS: true, allowTaint: true, backgroundColor: null }).then(canvas => { const a = document.createElement('a'); a.href = canvas.toDataURL(); a.download = '2026-æ„¿æœ›å•.png'; a.click(); }); }
    function uploadBg(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function (e) { setBgImage(e.target.result); }; reader.readAsDataURL(input.files[0]); } }
    function setBgImage(url) { const area = document.getElementById('capture-area'); area.style.backgroundColor = 'transparent'; area.style.backgroundImage = `url('${url}')`; area.style.boxShadow = "inset 0 0 20px rgba(0,0,0,0.5)"; }
    function setBgColor(color) { const area = document.getElementById('capture-area'); area.style.backgroundImage = 'none'; area.style.backgroundColor = color; area.style.boxShadow = "0 0 50px rgba(0,0,0,0.5)"; }

    // --- çƒŸèŠ± ---
    const canvas = document.getElementById('fireworks'); const ctx = canvas.getContext('2d');
    let particles = []; function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; } window.onresize = resize; resize();
    class Particle { constructor(x, y, color) { this.x = x; this.y = y; this.color = color; this.velocity = { x: (Math.random() - 0.5) * 12, y: (Math.random() - 0.5) * 12 }; this.alpha = 1; this.friction = 0.96; } draw() { ctx.save(); ctx.globalAlpha = this.alpha; ctx.beginPath(); ctx.arc(this.x, this.y, 2.5, 0, Math.PI * 2); ctx.fillStyle = this.color; ctx.fill(); ctx.restore(); } update() { this.velocity.x *= this.friction; this.velocity.y *= this.friction; this.x += this.velocity.x; this.y += this.velocity.y; this.alpha -= 0.01; } }
    function startFireworks() { function animate() { if (!document.getElementById('view-1').classList.contains('active')) return; requestAnimationFrame(animate); ctx.clearRect(0, 0, canvas.width, canvas.height); if (Math.random() < 0.1) { const colors = ['#gold', '#fff', '#ffeb3b']; const x = Math.random() * canvas.width, y = Math.random() * canvas.height * 0.4; for (let i = 0; i < 60; i++) particles.push(new Particle(x, y, colors[Math.floor(Math.random() * colors.length)])); } particles.forEach((p, i) => { if (p.alpha > 0) { p.update(); p.draw(); } else { particles.splice(i, 1); } }); } animate(); }

    initApp();
</script>
</body>
</html>
